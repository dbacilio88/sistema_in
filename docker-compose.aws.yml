# Override para deployment en AWS
# Usar: docker-compose -f docker-compose.yml -f docker-compose.aws.yml --env-file .env.aws up -d

services:
  frontend:
    env_file:
      - .env.aws
    environment:
      NODE_ENV: production
      WATCHPACK_POLLING: "false"
      
  django:
    env_file:
      - .env.aws
    environment:
      # Mantener conexiones internas con nombres de contenedores
      POSTGRES_HOST: postgres
      REDIS_URL: redis://redis:6379/0
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-SecurePassword123!}@rabbitmq:5672/
      MINIO_ENDPOINT: minio:9000
      
  inference:
    env_file:
      - .env.aws
    environment:
      INFERENCE_DEVICE: ${INFERENCE_DEVICE:-cpu}
      # URLs internas - siguen usando nombres de contenedores  
      DATABASE_URL: postgresql://${DB_USER:-admin}:${DB_PASSWORD:-SecurePassword123!}@postgres:5432/${DB_NAME:-traffic_system}
      REDIS_URL: redis://redis:6379/0
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-SecurePassword123!}@rabbitmq:5672/
      MINIO_ENDPOINT: minio:9000
      DJANGO_API_URL: http://django:8000
      
  config-management:
    env_file:
      - .env.aws
    environment:
      ENVIRONMENT: production
      # URLs internas - siguen usando nombres de contenedores
      POSTGRES_HOST: postgres
      REDIS_URL: redis://redis:6379/3
      DJANGO_API_URL: http://django:8000
      ML_SERVICE_URL: http://inference:8001

  # NGINX Reverse Proxy with SSL
  nginx:
    image: nginx:alpine
    container_name: traffic-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx-ssl.conf:/etc/nginx/conf.d/default.conf
      - ./ssl:/etc/nginx/ssl:ro
      - django_static:/app/staticfiles:ro
      - django_media:/app/media:ro
    depends_on:
      - frontend
      - django
      - inference
    networks:
      - traffic-network
    restart: unless-stopped
    environment:
      - NGINX_ENVSUBST_TEMPLATE_DIR=/etc/nginx/templates
      - NGINX_ENVSUBST_OUTPUT_DIR=/etc/nginx/conf.d