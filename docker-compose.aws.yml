version: '3.8'

# Override para deployment en AWS
services:
  frontend:
    environment:
      NODE_ENV: production
      # URLs para el navegador (cliente) - deben usar IP p√∫blica
      NEXT_PUBLIC_API_URL: http://${PUBLIC_IP:-0.0.0.0}:8000
      NEXT_PUBLIC_ML_SERVICE_URL: http://${PUBLIC_IP:-0.0.0.0}:8001
      NEXT_PUBLIC_WS_URL: ws://${PUBLIC_IP:-0.0.0.0}:8000
      NEXT_PUBLIC_WS_INFERENCE_URL: ws://${PUBLIC_IP:-0.0.0.0}:8001/api/ws/inference
      # URLs internas del servidor (SSR) - usan nombres de contenedores
      API_URL: http://django:8000
      ML_SERVICE_URL: http://inference:8001
      WATCHPACK_POLLING: "false"
      
  django:
    environment:
      DEBUG: "False"
      ALLOWED_HOSTS: "localhost,127.0.0.1,0.0.0.0,${PUBLIC_IP:-0.0.0.0},django,traffic-django"
      SECURE_SSL_REDIRECT: "False"
      # URLs internas - siguen usando nombres de contenedores
      POSTGRES_HOST: postgres
      REDIS_URL: redis://redis:6379/0
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-SecurePassword123!}@rabbitmq:5672/
      MINIO_ENDPOINT: minio:9000
      
  inference:
    environment:
      INFERENCE_DEVICE: ${INFERENCE_DEVICE:-cpu}
      # URLs internas - siguen usando nombres de contenedores  
      DATABASE_URL: postgresql://${DB_USER:-admin}:${DB_PASSWORD:-SecurePassword123!}@postgres:5432/${DB_NAME:-traffic_system}
      REDIS_URL: redis://redis:6379/0
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-SecurePassword123!}@rabbitmq:5672/
      MINIO_ENDPOINT: minio:9000
      DJANGO_API_URL: http://django:8000
      
  config-management:
    environment:
      ENVIRONMENT: production
      # URLs internas - siguen usando nombres de contenedores
      POSTGRES_HOST: postgres
      REDIS_URL: redis://redis:6379/3
      DJANGO_API_URL: http://django:8000
      ML_SERVICE_URL: http://inference:8001